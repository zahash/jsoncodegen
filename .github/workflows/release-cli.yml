name: Release CLI

# Manual trigger from the GitHub UI
on:
    workflow_dispatch: {}

jobs:
    # Linux matrix
    build-linux:
        name: Build (Linux) ${{ matrix.target }}
        runs-on: ubuntu-latest
        strategy:
            matrix:
                target:
                    - x86_64-unknown-linux-gnu
                    - aarch64-unknown-linux-gnu
                    - i686-unknown-linux-gnu
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable

            - name: Add target
              run: rustup target add ${{ matrix.target }}

            - name: Build (package=jcg, profile=cli)
              run: cargo build --package jcg --profile cli --target "${{ matrix.target }}"

            - name: Upload artifact (Linux)
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-${{ matrix.target }}
                  path: target/${{ matrix.target }}/cli/jcg*

    # Windows MSVC (x86_64 + i686)
    build-windows-msvc:
        name: Build (Windows MSVC)
        runs-on: windows-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable

            - name: Add MSVC targets
              run: rustup target add x86_64-pc-windows-msvc i686-pc-windows-msvc

            - name: Build x86_64-pc-windows-msvc
              run: cargo build --package jcg --profile cli --target x86_64-pc-windows-msvc

            - name: Build i686-pc-windows-msvc
              run: cargo build --package jcg --profile cli --target i686-pc-windows-msvc

            - name: Upload x86_64 Windows artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-x86_64-pc-windows-msvc
                  path: target/x86_64-pc-windows-msvc/cli/jcg*.exe

            - name: Upload i686 Windows artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-i686-pc-windows-msvc
                  path: target/i686-pc-windows-msvc/cli/jcg*.exe

    # Windows ARM64 MSVC (runner: windows-11-arm)
    build-windows-arm64:
        name: Build (Windows ARM64 MSVC)
        runs-on: windows-11-arm
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable

            - name: Add ARM64 MSVC target
              run: rustup target add aarch64-pc-windows-msvc

            - name: Build aarch64-pc-windows-msvc
              run: cargo build --package jcg --profile cli --target aarch64-pc-windows-msvc

            - name: Upload ARM64 Windows artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-aarch64-pc-windows-msvc
                  path: target/aarch64-pc-windows-msvc/cli/jcg*.exe

    # macOS (x86_64 + aarch64)
    build-macos:
        name: Build (macOS)
        runs-on: macos-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Install Rust
              uses: actions-rs/toolchain@v1
              with:
                  toolchain: stable

            - name: Add macOS targets
              run: rustup target add x86_64-apple-darwin aarch64-apple-darwin

            - name: Build x86_64-apple-darwin
              run: cargo build --package jcg --profile cli --target x86_64-apple-darwin

            - name: Build aarch64-apple-darwin
              run: cargo build --package jcg --profile cli --target aarch64-apple-darwin

            - name: Upload x86_64 macOS artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-x86_64-apple-darwin
                  path: target/x86_64-apple-darwin/cli/jcg*

            - name: Upload aarch64 macOS artifact
              uses: actions/upload-artifact@v4
              with:
                  name: jcg-aarch64-apple-darwin
                  path: target/aarch64-apple-darwin/cli/jcg*
